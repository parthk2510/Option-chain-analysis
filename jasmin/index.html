<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      h1 {
        text-align: center;
        margin-top: 20px;
      }

      form {
        text-align: center;
        margin-bottom: 20px;
      }

      table {
        margin: 0 auto;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
      }

      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h1>Option Chain</h1>
    <form>
      <select id="symbol-select" name="symbol"></select> <!-- Dynamic dropdown for symbols -->
      <select id="expiry-select" name="expiry"></select> <!-- Dynamic dropdown for expiry dates -->
    </form>
    <table id="data-table"></table>

    <script>
      var selectedSymbol = ""; // Variable to store the selected symbol
    
      function getData() {
        $.ajax({
          url: "http://127.0.0.1:5000/symbols", // Fetch unique symbols
          method: "GET",
          success: function (response) {
            populateDropdown(response); // Populate the dropdown with symbols
          },
          error: function (xhr, status, error) {
            console.log(error);
          },
        });
      }
    
      function populateDropdown(symbols) {
        var symbolSelect = $("#symbol-select");
        var selected = symbolSelect.val(); // Get the currently selected symbol
    
        symbolSelect.empty();
    
        // Add an option for each symbol
        symbols.forEach(function (symbol) {
          var option = $("<option></option>")
            .attr("value", symbol)
            .text(symbol);
    
          if (symbol === selected) {
            option.attr("selected", "selected"); // Set the selected option
          }
    
          symbolSelect.append(option);
        });
    
        // Update the selected symbol variable
        selectedSymbol = selected;
      }
    
      function updateDataList(data) {
        var dataTable = $("#data-table");
        dataTable.empty();
    
        var tableHeader = `
          <tr>
            <th>Expiry Date</th>
            <th>Option Type</th>
            <th>Strike Price</th>
            <th>Last Traded Price</th>
            <th>OI</th>
            <th>Change in OI</th>
            <th>Volume</th>
            <th>IV</th>
            <th>Bid Qty</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Ask Qty</th>
            <th>Net Change</th>
          </tr>`;
    
        dataTable.append(tableHeader);
    
        data.forEach(function (item) {
          var row = `
            <tr>
              <td>${item.expiry_date}</td>
              <td>${item.option}</td>
              <td>${item.strikePrice}</td>
              <td>${item.LTP}</td>
              <td>${item.openInterest}</td>
              <td>${item.changeInOi}</td>
              <td>${item.totalTradedVolume}</td>
              <td>${item.iv}</td>
              <td>${item.bestBidQty}</td>
              <td>${item.bestBid}</td>
              <td>${item.bestAsk}</td>
              <td>${item.bestAskQty}</td>
              <td>${item.change}</td>
            </tr>`;
    
          dataTable.append(row);
        });
      }
    
      // Event listener for dropdown menu change
      $("#symbol-select").change(function () {
        var symbol = $(this).val();
        selectedSymbol = symbol; // Update the selected symbol variable
    
        $.ajax({
          url: "http://127.0.0.1:5000/data", // URL to fetch data based on symbol
          method: "GET",
          data: { symbol: symbol },
          success: function (response) {
            console.log(response);
            updateDataList(response);
          },
          error: function (xhr, status, error) {
            console.log(error);
          },
        });
      });
    
      // Poll for updates every 5 seconds
      setInterval(function () {
        // Set the selected value of the dropdown to retain the selection
        $("#symbol-select").val(selectedSymbol);
    
        getData();
      }, 5000);
    
      // Initial data retrieval
      getData();
    </script>
    
  </body>
</html>
