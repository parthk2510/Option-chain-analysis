<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      h1 {
        text-align: center;
        margin-top: 20px;
      }

      .container {
        display: flex;
        justify-content: space-between;
        max-width: 1000px;
        margin: 0 auto;
      }

      .calls-table,
      .puts-table {
        border-collapse: collapse;
        width: 48%;
      }

      .calls-table th,
      .calls-table td,
      .puts-table th,
      .puts-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
      }

      .calls-table th,
      .calls-table td {
        background-color: #f2f2f2;
        font-weight: bold;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h1>Option Chain</h1>
    <form>
      <select id="symbol-select" name="symbol"></select>
      <!-- Dynamic dropdown for symbols -->
      <select id="expiry-select" name="expiry_date"></select>
      <!-- Dynamic dropdown for expiry dates -->
    </form>
    <div class="container">
      <table id="calls-table" class="calls-table">
        <thead>
          <tr>
            <th>Strike Price</th>
            <th>Last Traded Price</th>
            <th>OI</th>
            <th>Change in OI</th>
            <th>Volume</th>
            <th>IV</th>
            <th>Bid Qty</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Ask Qty</th>
            <th>Net Change</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <table id="puts-table" class="puts-table">
        <thead>
          <tr>
            <th>Strike Price</th>
            <th>Last Traded Price</th>
            <th>OI</th>
            <th>Change in OI</th>
            <th>Volume</th>
            <th>IV</th>
            <th>Bid Qty</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Ask Qty</th>
            <th>Net Change</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      function populateDropdown(selectId, options) {
        var select = $(selectId);
        var selectedValue = select.val();

        select.empty();

        options.forEach(function (option) {
          var optionElement = $("<option></option>")
            .attr("value", option)
            .text(option);

          if (option === selectedValue) {
            optionElement.attr("selected", "selected");
          }

          select.append(optionElement);
        });
      }

      function fetchData() {
        var symbol = $("#symbol-select").val();
        var expiryDate = $("#expiry-select").val();

        $.ajax({
          url: "http://127.0.0.1:5000/data", // URL to fetch data based on symbol and expiry date
          method: "GET",
          data: { symbol: symbol, expiry_date: expiryDate },
          success: function (response) {
            updateDataList(response);
          },
          error: function (xhr, status, error) {
            console.log(error);
          },
        });
      }

      function updateDataList(data) {
        var callsTable = $("#calls-table");
        var putsTable = $("#puts-table");

        callsTable.find("tbody").empty();
        putsTable.find("tbody").empty();

        data.sort(function (a, b) {
          return a.strikePrice - b.strikePrice;
        });

        var mergedData = {};
        data.forEach(function (item) {
          var strikePrice = item.strikePrice;

          if (!mergedData[strikePrice]) {
            mergedData[strikePrice] = { calls: [], puts: [] };
          }

          if (item.option === "CE") {
            mergedData[strikePrice].calls.push(item);
          } else if (item.option === "PE") {
            mergedData[strikePrice].puts.push(item);
          }
        });

        for (var strikePrice in mergedData) {
          var mergedItem = mergedData[strikePrice];

          mergedItem.calls.forEach(function (callItem) {
            mergedItem.puts.forEach(function (putItem) {
              var callsRow = `<tr>
                <td>${callItem.strikePrice}</td>
                <td>${callItem.LTP}</td>
                <td>${callItem.openInterest}</td>
                <td>${callItem.changeInOi}</td>
                <td>${callItem.totalTradedVolume}</td>
                <td>${callItem.iv}</td>
                <td>${callItem.bestBidQty}</td>
                <td>${callItem.bestBid}</td>
                <td>${callItem.bestAsk}</td>
                <td>${callItem.bestAskQty}</td>
                <td>${callItem.change}</td>
              </tr>`;

              var putsRow = `<tr>
                <td>${putItem.strikePrice}</td>
                <td>${putItem.LTP}</td>
                <td>${putItem.openInterest}</td>
                <td>${putItem.changeInOi}</td>
                <td>${putItem.totalTradedVolume}</td>
                <td>${putItem.iv}</td>
                <td>${putItem.bestBidQty}</td>
                <td>${putItem.bestBid}</td>
                <td>${putItem.bestAsk}</td>
                <td>${putItem.bestAskQty}</td>
                <td>${putItem.change}</td>
              </tr>`;

              var row = callsRow + putsRow;

              callsTable.find("tbody").append(row);
              putsTable.find("tbody").append(row);
            });
          });
        }
      }

      function fetchSymbols() {
        $.ajax({
          url: "http://127.0.0.1:5000/symbols", // Fetch symbols
          method: "GET",
          success: function (symbols) {
            populateDropdown("#symbol-select", symbols); // Populate the symbol dropdown
            fetchExpiryDates(); // Fetch expiry dates for the initial selected symbol
          },
          error: function (xhr, status, error) {
            console.log(error);
          },
        });
      }

      function fetchExpiryDates() {
        var symbol = $("#symbol-select").val();

        $.ajax({
          url: "http://127.0.0.1:5000/expiry-dates", // Fetch expiry dates based on symbol
          method: "GET",
          data: { symbol: symbol },
          success: function (expiryDates) {
            populateDropdown("#expiry-select", expiryDates); // Populate the expiry date dropdown
            fetchData(); // Fetch data for the initial selected symbol and expiry date
          },
          error: function (xhr, status, error) {
            console.log(error);
          },
        });
      }

      // Event listener for symbol dropdown menu change
      $("#symbol-select").change(function () {
        fetchExpiryDates(); // Fetch expiry dates for the selected symbol
      });

      // Event listener for expiry date dropdown menu change
      $("#expiry-select").change(function () {
        fetchData(); // Fetch data for the selected symbol and expiry date
      });

      // Initial data retrieval
      fetchSymbols();
    </script>
  </body>
</html>
